<!DOCTYPE html>
<html lang="en-us">
  <head>
  <title>Trying OpenCL on Guix: An Experience Report - Katherine Cox-Buday</title>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="author" content="Katherine Cox-Buday" />

  <!-- Mobile support -->
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <link rel="stylesheet" href="/media/css/main.css" type="text/css">
  <!-- <link rel="stylesheet" href="/media/css/prettify.css" type="text/css"> -->

  <!-- Latest compiled and minified CSS -->
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.1/css/bootstrap.min.css">
  <!-- Optional theme -->
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.1/css/bootstrap-theme.min.css">
  <!-- Latest compiled and minified JavaScript -->
  <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.2.0/css/font-awesome.min.css" rel="stylesheet">
</head>

  <body>
    <div class="container">
      <div class="row">
        <div class="col-sm-9 blog-main">
          <div class="post">
  <div class="col-sm-3 right-align post-meta">
    <h3>&nbsp;<!-- Placeholder for alignment with post --></h3>
  </div>
  <div class="col-sm-9">
    <div class="post">
      <h3>Trying OpenCL on Guix: An Experience Report</h3>
      <p>
Recently, I wanted to run <a href="https://github.com/leela-zero/leela-zero">Leela Zero</a> with <a href="https://github.com/bernds/q5Go">q5go</a> to help me get better at playing Go. I run <a href="https://guix.gnu.org/">GNU Guix</a> on my machine, and so I did the following: <code>guix package -i leela-zero gnugo q5go</code>. This got <code>q5go</code> going and I was able to point it at Leela Zero (<code>~/.guix-profile/bin/leelaz</code>) as an analysis engine; however, it does not work. Here is my experience determining why.
</p>

<p>
Like many machine learning programs, Leela Zero can optionally use your GPU utilizing OpenCL to drastically speed up its operations per second. Unfortunately, invoking <code>leelaz</code> with <code>leelaz --gtp</code> wasn't working for me. If I invoked Leela Zero like this: <code>leelaz --cpu-only</code> it worked, but took a long time to analyze moves. This suggested to me that it was an issue with my OpenCL setup. We can use the <code>clinfo</code> program to troubleshoot this.
</p>

<div class="org-src-container">
<pre class="src src-shell">guix environment --ad-hoc clinfo -- clinfo
</pre>
</div>

<pre class="example">
Number of platforms                               0
</pre>


<p>
This strongly suggests there is something wrong with Guix's OpenCL setup. We can use <code>strace</code> to learn more.
</p>

<div class="org-src-container">
<pre class="src src-shell">guix environment --ad-hoc strace clinfo -- strace -o/dev/stdout -eopenat clinfo
</pre>
</div>

<pre class="example">
openat(AT_FDCWD, "/gnu/store/2ax9z25142khhqx61ks767jr758pzq5r-clinfo-3.0.21.02.21/etc/ld.so.cache", O_RDONLY|O_CLOEXEC) = 3
openat(AT_FDCWD, "/gnu/store/i70jq190cpc45crbnrw8g8lgb4djyi9r-opencl-icd-loader-2021.06.30/lib/libOpenCL.so.1", O_RDONLY|O_CLOEXEC) = 3
openat(AT_FDCWD, "/gnu/store/5h2w4qi9hk1qzzgi1w83220ydslinr4s-glibc-2.33/lib/libdl.so.2", O_RDONLY|O_CLOEXEC) = 3
openat(AT_FDCWD, "/gnu/store/094bbaq6glba86h1d4cj16xhdi6fk2jl-gcc-10.3.0-lib/lib/libgcc_s.so.1", O_RDONLY|O_CLOEXEC) = 3
openat(AT_FDCWD, "/gnu/store/5h2w4qi9hk1qzzgi1w83220ydslinr4s-glibc-2.33/lib/libc.so.6", O_RDONLY|O_CLOEXEC) = 3
openat(AT_FDCWD, "/gnu/store/5h2w4qi9hk1qzzgi1w83220ydslinr4s-glibc-2.33/lib/libpthread.so.0", O_RDONLY|O_CLOEXEC) = 3
openat(AT_FDCWD, "/etc/OpenCL/vendors", O_RDONLY|O_NONBLOCK|O_CLOEXEC|O_DIRECTORY) = -1 ENOENT (No such file or directory)
Number of platforms                               0
+++ exited with 0 +++
</pre>


<p>
Despite <code>mesa-opencl</code> being installed in the system profile, Guix had not populated <code>/etc/OpenCL</code> from the package. It is, however present:
</p>

<div class="org-src-container">
<pre class="src src-shell">find -L /run/current-system/profile -name OpenCL
</pre>
</div>

<pre class="example">
/run/current-system/profile/etc/OpenCL
</pre>


<p>
This is mystery number one: why isn't this being populated into Guix's root <code>/etc</code>?
</p>

<p>
Pointing <code>clinfo</code> at the vendors directory can be achieved with the <code>OPENCL_VENDOR_PATH</code> environmental variable. The contents of this file are:
</p>

<div class="org-src-container">
<pre class="src src-shell">cat /run/current-system/profile/etc/OpenCL/vendors/mesa.icd
</pre>
</div>

<pre class="example">
/gnu/store/48qh6x7ky8r1cxbfalwzngch4hgnrrr9-mesa-opencl-icd-21.3.8/lib/libMesaOpenCL.so.1
</pre>


<p>
By running <code>strace</code>, we can see that despite <code>mesa-opencl-icd</code> being installed in the system's profile, it cannot find the location of the library:
</p>

<div class="org-src-container">
<pre class="src src-shell">OPENCL_VENDOR_PATH=/run/current-system/profile/etc/OpenCL/vendors guix environment --ad-hoc strace clinfo -- strace -o/dev/stdout -eopenat clinfo
</pre>
</div>

<pre class="example">
openat(AT_FDCWD, "/gnu/store/2ax9z25142khhqx61ks767jr758pzq5r-clinfo-3.0.21.02.21/etc/ld.so.cache", O_RDONLY|O_CLOEXEC) = 3
openat(AT_FDCWD, "/gnu/store/i70jq190cpc45crbnrw8g8lgb4djyi9r-opencl-icd-loader-2021.06.30/lib/libOpenCL.so.1", O_RDONLY|O_CLOEXEC) = 3
openat(AT_FDCWD, "/gnu/store/5h2w4qi9hk1qzzgi1w83220ydslinr4s-glibc-2.33/lib/libdl.so.2", O_RDONLY|O_CLOEXEC) = 3
openat(AT_FDCWD, "/gnu/store/094bbaq6glba86h1d4cj16xhdi6fk2jl-gcc-10.3.0-lib/lib/libgcc_s.so.1", O_RDONLY|O_CLOEXEC) = 3
openat(AT_FDCWD, "/gnu/store/5h2w4qi9hk1qzzgi1w83220ydslinr4s-glibc-2.33/lib/libc.so.6", O_RDONLY|O_CLOEXEC) = 3
openat(AT_FDCWD, "/gnu/store/5h2w4qi9hk1qzzgi1w83220ydslinr4s-glibc-2.33/lib/libpthread.so.0", O_RDONLY|O_CLOEXEC) = 3
openat(AT_FDCWD, "/etc/OpenCL/vendors", O_RDONLY|O_NONBLOCK|O_CLOEXEC|O_DIRECTORY) = -1 ENOENT (No such file or directory)
Number of platforms                               0
+++ exited with 0 +++
</pre>


<p>
It is, however, present:
</p>

<div class="org-src-container">
<pre class="src src-shell">find -L /run/current-system/profile -name libMesaOpenCL.so.1
</pre>
</div>

<pre class="example">
/run/current-system/profile/lib/libMesaOpenCL.so.1
</pre>


<p>
This is mystery number two: why can't Guix locate the library?
</p>

<p>
If we create our own vendors file, populate it with the location of the <code>libMesaOpenCL.so</code> file, and point <code>clinfo</code> at this, things begin to look better.
</p>

<div class="org-src-container">
<pre class="src src-shell">cat ${HOME}/.local/etc/OpenCL/vendors/mesa.icd
</pre>
</div>

<pre class="example">
/run/current-system/profile/lib/libMesaOpenCL.so.1
</pre>


<div class="org-src-container">
<pre class="src src-shell">OPENCL_VENDOR_PATH=${HOME}/.local/etc/OpenCL/vendors clinfo
</pre>
</div>

<pre class="example">
Number of platforms                               0
</pre>


<p>
However, Leela Zero is still not working:
</p>

<div class="org-src-container">
<pre class="src src-shell">OPENCL_VENDOR_PATH=${HOME}/.local/etc/OpenCL/vendors leelaz --tune-only 2&gt;&amp;1 || true
</pre>
</div>

<pre class="example">
A network weights file is required to use the program.
By default, Leela Zero looks for it in /home/katco/.local/share/leela-zero/best-network.
</pre>


<p>
There is a curious error from the output of <code>clinfo</code>:
</p>

<p>
<code>Preferred work group size multiple              &lt;getWGsizes:1200: create kernel : error -46&gt;</code>
</p>

<p>
If we set the <code>LD_DEBUG</code> environment variable to <code>libs</code>, we can shed some light as to what is wrong:
</p>

<div class="org-src-container">
<pre class="src src-shell">OPENCL_VENDOR_PATH=${HOME}/.local/etc/OpenCL/vendors LD_DEBUG=libs clinfo 2&gt;&amp;1 |grep error
</pre>
</div>

<p>
Indeed, this file is not present.
</p>

<div class="org-src-container">
<pre class="src src-shell">[ -f /gnu/store/h86b3253bc3mnp3p57n1vls2vkfv2h6z-libclc-9.0.1/share/clc/gfx1010-amdgcn-mesa-mesa3d.bc ]
echo $?
</pre>
</div>

<pre class="example">
1
</pre>


<p>
Further research turned up a bug (<a href="https://bugs.llvm.org/show_bug.cgi?id=44841">44841</a>) against <code>libclc</code> which suggests that while support for my card was included into LLVM v10 (at the time of this writing, LLVM has released v12), <code>libclc</code> does not support my card's architecture, <code>gfx1010</code>.
</p>

<p>
I attempted to build libclc v12.0.0 locally, but it segfaulted. Building v11.0.0 worked, but as suggested by the open bug, support for my card's architecture still has not been implemented.
</p>

<p>
I briefly entertained creating a Guix package from AMD's <code>amdgpu-pro</code> <a href="https://www.amd.com/en/support/kb/release-notes/rn-radpro-lin-16-40">packages</a>, but it appears as though my card is not supported, and according to a bug (<a href="https://github.com/RadeonOpenCompute/ROCm/issues/819">819</a>) against ROCm, likely won't be.
</p>

<p>
So it would seem I'm out of luck, and I'm stuck running Leela Zero on the CPU for now. Analyzing one of my games on 60 compute cores took somewhere around ten minutes, so not intractable.
</p>

<p>
Still, perhaps this helps others running Guix with GPUs that are supported by <code>libclc</code>.
</p>

<p>
As an aside, this research is perhaps an indication of why — despite my years of interest in Go — I remain a Kyu player.
</p>

    </div>
  </div>
</div> <!-- /.container -->

        </div> <!-- /.blog-main -->
        <div class="col-sm-3 blog-sidebar">
          <div class="sidebar-module sidebar-module-inset">
  <a href="/"><span class="fa fa-home fa-2x"></span></a>
  <a href="/rss.xml"><span class="fa fa-rss-square fa-2x"></span></a>
  <a href="/tags/"><span class="fa fa-tags fa-2x"></span></a>
</div>
<div class="sidebar-module">
  <form method="get" id="searchform" action="http://www.google.com/search">
    <input type="text" class="form-control" name="q" id="s" placeholder="Search">
    <input type="hidden" name="q" value="site:katherine.cox-buday.com">
  </form>
</div>
<div class="sidebar-module">
  <h4>Categories</h4>
  <ol class="list-unstyled">
    <li><a href="/blog/">Blog</a></li>
    <li><a href="/concurrency-in-go/">Concurrency in Go</a></li>
    <li><a href="/talks/">Talks</a></li>
    <!-- <li><a href="https://github.com/kelvinh/org-page">GitHub</a></li> -->
  </ol>
</div>
        </div> <!-- /.blog-sidebar -->
      </div> <!-- /.row -->
    </div> <!-- /.container -->
    <script src="//code.jquery.com/jquery-latest.min.js"></script>
<script src="//maxcdn.bootstrapcdn.com/bootstrap/3.3.1/js/bootstrap.min.js"></script>
<script src="https://google-code-prettify.googlecode.com/svn/loader/prettify.js"></script>
<script src="/media/js/main.js"></script>
<!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
<!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
    <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
<div class="container">
  <script type="text/javascript">
    $('.post-meta').append('<ul class="list-unstyled"><li><span title="post date" class="post-info">2021-07-05</span></li><li><span title="tags" class="post-info"><a href="/tags/tech/">tech</a></span></li></ul>');
  </script>
</div> <!-- /.container -->

<footer class="footer">
  <div class="container text-muted">
    <div class="row" style="heigh:2em;">
      <div class="col-md-2 vertical-center">
        <a href="https://github.com/kat-co"><span class="fa fa-github-square fa-2x"></span></a>
        <a href="http://www.linkedin.com/in/katherinecoxbuday"><span class="fa fa-linkedin-square fa-2x"></span></a>
        <a rel="me" href="https://mstdn.social/@katco"><span class="fa fa-link fa-2x"></span></a>
      </div>
      <div class="col-sm-9 vertical-center">
        Copyright &copy; <a href="mailto:cox &lt;dot&gt; katherine &lt;dot&gt; e &lt;at&gt; gmail &lt;dot&gt; com">Katherine Cox-Buday</a>,
        Generated by <a href="http://www.gnu.org/software/emacs/">Emacs</a> 28.x (<a href="http://orgmode.org">Org mode</a> 9.x) & <a href="https://github.com/kelvinh/org-page" target="_blank">org-page</a>
      </div>
    </div> <!-- ./row -->
  </div> <!-- ./container -->
</footer>

  </body>
</html>
