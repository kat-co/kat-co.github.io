<?xml version="1.0" encoding="utf-8"?>
<rss version="2.0">
  <channel>
    <title>Katherine Cox-Buday</title>
    <link>http://katherine.cox-buday.com</link>
    <description>static site generator</description>
    <pubDate>Tue, 01 Nov 2022 18:54:58 MDT</pubDate>
    <lastBuildDate>Tue, 01 Nov 2022 18:54:58 MDT</lastBuildDate>
    <docs>http://www.rssboard.org/rss-specification</docs>
    <generator>Org-page static site generator (https://github.com/kelvinh/org-page)</generator>
    <item>
      <title>On Twitter&#39;s Acquisition, and Leaving</title>
      <link>http://katherine.cox-buday.com/blog/2022/11/01/on-twitters-acquisition-and-leaving/</link>
      <description><![CDATA[<div class="post">
  <div class="col-sm-3 right-align post-meta">
    <h3>&nbsp;<!-- Placeholder for alignment with post --></h3>
  </div>
  <div class="col-sm-9">
    <div class="post">
      <h3>On Twitter&#39;s Acquisition, and Leaving</h3>
      <p>
Since Twitter changed hands, I've seen calls for people to remain on the platform in an effort to not cede it to those with extremist views, and to keep communities connected. Although worthy goals, I don't think remaining on the platform is a great idea, and I wanted to share my opinion in the hopes it will influence people, communities, and public services, to change how they engage with society.
</p>

<p>
This is an odd issue for me to take a stance on because I abandoned social media awhile ago. It's unclear to me that its benefits outweigh its risks to society<sup><a id="fnr.1" class="footref" href="#fn.1" role="doc-backlink">1</a></sup>. As a life-long netizen who has benefited immensely from online spaces over the years, I also understand that these spaces are important, and that for many, a vital and sometimes life-saving alternative to the real world. I'm just not sure about social media in it's current form. Still, a lot of people like and use it, and what happens with Twitter will impact me, indirectly. So onto the question: why shouldn't people stay?
</p>

<p>
⚜
</p>

<p>
The value in Twitter, and any social media network, comes from the people who engage with it. These networks don't produce any content; that comes from you. And you wouldn't put content into the network unless you thought someone was going to read it. It's a positive feedback loop: the more you feed the machine, the more valuable the machine becomes, to the public, and, more importantly, to those who control it. In Twitter's case, one person now controls it, and the people he borrowed money from control him. Is this is the platform we want to be society's "town square"? To host our political discourse? To hear from our public servants?
</p>

<p>
If you fear Twitter becoming a mouthpiece for extremism, disinformation, and mass manipulation, the best way to resist isn't to stay, it's to exit the platform. With fewer accounts, there will be fewer people feeding it content, and less reason for those who remain to do so: a negative feedback loop. Its importance will wane. Starved and spiraling, it will cease to be the "town square", and like many social networks before it, it will fade away. Remaining, at best, ensures the platform retains its status, and — if your fears are true — thus ensures extremism, disinformation, and mass manipulation have an audience.
</p>

<p>
If you fear your community fracturing, I don't think there's a way to stop this. This acquisition has already driven people away, and it will continue to do so. The best way to keep communities connected, and to ensure this doesn't happen again, is to reform the community around a platform where this type of thing could never happen in the first place, and then exiting the one where it did. Even if you somehow avoid shedding community members, the risk remains going forward: someone you don't trust is dictating the rules, and the community could disband or involuntarily be disbanded at any point.
</p>

<p>
Which brings me to my most important point: trying to resist within a system of rules your opponent dictates is pointless. You can tweet the best take-down of Twitter ever written, and they can ensure no one sees it. You can start a banging hashtag campaign, and they can ensure no one sees it. You can confront disinformation and offer insight into why it's untrue, and their algorithm can make sure no one sees it. They can outright delete your account: the tool you've chosen for resisting. You have no agency from which to resist.
</p>

<p>
For example, I've seen claims that leaving now is disrupting the means of mass communication right before what's expected to be a tumultuous US election. Setting aside the fact that Twitter isn't the only way people communicate en masse, if that's something important to you, why would you want to depend on a platform you have no confidence in? Wouldn't it be <i>more</i> important to start building your network on something you know won't be manipulating its users?
</p>

<p>
Wasn't there an entire <a href="https://en.wikipedia.org/wiki/The_Matrix">movie</a> about this? Wasn't the problem that trying to resist from within was pointless? Wasn't the solution to exit? Exit.
</p>

<p>
⚜
</p>

<p>
If you agree, but are unsure what to do, here are some suggestions:
</p>

<ul class="org-ul">
<li>Join a federated network.
These operate like email: every member can interact with every other member, regardless of which provider they use. There are many more benefits (and some drawbacks), but it removes any private, central, control on what has become an important substrate of our society. I suggest <a href="https://joinmastodon.org/servers">Mastadon</a>. From what I'm told, it doesn't behave exactly like Twitter, but it's a functioning, useful, social network.</li>
<li>As I have for this post, practice <a href="https://indieweb.org/POSSE">POSSE</a> (Publish (on your) Own Site, Syndicate Elsewhere). The linked site has a great breakdown of why this is useful, including a point on "Friends are more important than federation".</li>
<li>Support <a href="https://www.eff.org/deeplinks/2021/06/access-act-takes-step-towards-more-interoperable-future">political efforts</a> which require platforms to federate.</li>
</ul>


<p>
And, next time a curmudgeon like me <a href="https://usesthis.com/interviews/katherine.cox-buday/">blathers on</a> about standards, protocols, ownership, and openness, consider that there may be a horizon, closer now than you think, where these things might be important, and in ways you didn't anticipate. And that <a href="https://www.cnet.com/culture/how-twitter-replaced-my-rss-reader/">the present convenience</a> won't be worth what we're giving up.
</p>
<div id="footnotes">
<h2 class="footnotes">Footnotes: </h2>
<div id="text-footnotes">

<div class="footdef"><sup><a id="fn.1" class="footnum" href="#fnr.1" role="doc-backlink">1</a></sup> <div class="footpara" role="doc-footnote"><p class="footpara">
In <a href="https://openlibrary.org/works/OL20730900W/How_to_Do_Nothing">How to Do Nothing</a>, Jenny Odell makes a compelling case that our attention is one of the few remaining commodities individuals have left to affect change, and that increasingly people are spending that attention engaging with inflammatory content on social media, while not actually doing anything substantive. I'm probably not representing her excellent and nuanced points well, so if that strikes a chord with you, go read the book.
</p></div></div>


</div>
</div>
    </div>
  </div>
</div> <!-- /.container -->
]]></description>
      <pubDate>2022-11-01</pubDate>
      <guid>http://katherine.cox-buday.com/blog/2022/11/01/on-twitters-acquisition-and-leaving/</guid>
    </item>
    <item>
      <title>Trying OpenCL on Guix: An Experience Report</title>
      <link>http://katherine.cox-buday.com/blog/2021/07/05/trying-opencl-on-guix-an-experience-report/</link>
      <description><![CDATA[<div class="post">
  <div class="col-sm-3 right-align post-meta">
    <h3>&nbsp;<!-- Placeholder for alignment with post --></h3>
  </div>
  <div class="col-sm-9">
    <div class="post">
      <h3>Trying OpenCL on Guix: An Experience Report</h3>
      <p>
Recently, I wanted to run <a href="https://github.com/leela-zero/leela-zero">Leela Zero</a> with <a href="https://github.com/bernds/q5Go">q5go</a> to help me get better at playing Go. I run <a href="https://guix.gnu.org/">GNU Guix</a> on my machine, and so I did the following: <code>guix package -i leela-zero gnugo q5go</code>. This got <code>q5go</code> going and I was able to point it at Leela Zero (<code>~/.guix-profile/bin/leelaz</code>) as an analysis engine; however, it does not work. Here is my experience determining why.
</p>

<p>
Like many machine learning programs, Leela Zero can optionally use your GPU utilizing OpenCL to drastically speed up its operations per second. Unfortunately, invoking <code>leelaz</code> with <code>leelaz --gtp</code> wasn't working for me. If I invoked Leela Zero like this: <code>leelaz --cpu-only</code> it worked, but took a long time to analyze moves. This suggested to me that it was an issue with my OpenCL setup. We can use the <code>clinfo</code> program to troubleshoot this.
</p>

<div class="org-src-container">
<pre class="src src-shell">guix environment --ad-hoc clinfo -- clinfo
</pre>
</div>

<pre class="example">
Number of platforms                               0
</pre>


<p>
This strongly suggests there is something wrong with Guix's OpenCL setup. We can use <code>strace</code> to learn more.
</p>

<div class="org-src-container">
<pre class="src src-shell">guix environment --ad-hoc strace clinfo -- strace -o/dev/stdout -eopenat clinfo
</pre>
</div>

<pre class="example">
openat(AT_FDCWD, "/gnu/store/2ax9z25142khhqx61ks767jr758pzq5r-clinfo-3.0.21.02.21/etc/ld.so.cache", O_RDONLY|O_CLOEXEC) = 3
openat(AT_FDCWD, "/gnu/store/i70jq190cpc45crbnrw8g8lgb4djyi9r-opencl-icd-loader-2021.06.30/lib/libOpenCL.so.1", O_RDONLY|O_CLOEXEC) = 3
openat(AT_FDCWD, "/gnu/store/5h2w4qi9hk1qzzgi1w83220ydslinr4s-glibc-2.33/lib/libdl.so.2", O_RDONLY|O_CLOEXEC) = 3
openat(AT_FDCWD, "/gnu/store/094bbaq6glba86h1d4cj16xhdi6fk2jl-gcc-10.3.0-lib/lib/libgcc_s.so.1", O_RDONLY|O_CLOEXEC) = 3
openat(AT_FDCWD, "/gnu/store/5h2w4qi9hk1qzzgi1w83220ydslinr4s-glibc-2.33/lib/libc.so.6", O_RDONLY|O_CLOEXEC) = 3
openat(AT_FDCWD, "/gnu/store/5h2w4qi9hk1qzzgi1w83220ydslinr4s-glibc-2.33/lib/libpthread.so.0", O_RDONLY|O_CLOEXEC) = 3
openat(AT_FDCWD, "/etc/OpenCL/vendors", O_RDONLY|O_NONBLOCK|O_CLOEXEC|O_DIRECTORY) = -1 ENOENT (No such file or directory)
Number of platforms                               0
+++ exited with 0 +++
</pre>


<p>
Despite <code>mesa-opencl</code> being installed in the system profile, Guix had not populated <code>/etc/OpenCL</code> from the package. It is, however present:
</p>

<div class="org-src-container">
<pre class="src src-shell">find -L /run/current-system/profile -name OpenCL
</pre>
</div>

<pre class="example">
/run/current-system/profile/etc/OpenCL
</pre>


<p>
This is mystery number one: why isn't this being populated into Guix's root <code>/etc</code>?
</p>

<p>
Pointing <code>clinfo</code> at the vendors directory can be achieved with the <code>OPENCL_VENDOR_PATH</code> environmental variable. The contents of this file are:
</p>

<div class="org-src-container">
<pre class="src src-shell">cat /run/current-system/profile/etc/OpenCL/vendors/mesa.icd
</pre>
</div>

<pre class="example">
/gnu/store/48qh6x7ky8r1cxbfalwzngch4hgnrrr9-mesa-opencl-icd-21.3.8/lib/libMesaOpenCL.so.1
</pre>


<p>
By running <code>strace</code>, we can see that despite <code>mesa-opencl-icd</code> being installed in the system's profile, it cannot find the location of the library:
</p>

<div class="org-src-container">
<pre class="src src-shell">OPENCL_VENDOR_PATH=/run/current-system/profile/etc/OpenCL/vendors guix environment --ad-hoc strace clinfo -- strace -o/dev/stdout -eopenat clinfo
</pre>
</div>

<pre class="example">
openat(AT_FDCWD, "/gnu/store/2ax9z25142khhqx61ks767jr758pzq5r-clinfo-3.0.21.02.21/etc/ld.so.cache", O_RDONLY|O_CLOEXEC) = 3
openat(AT_FDCWD, "/gnu/store/i70jq190cpc45crbnrw8g8lgb4djyi9r-opencl-icd-loader-2021.06.30/lib/libOpenCL.so.1", O_RDONLY|O_CLOEXEC) = 3
openat(AT_FDCWD, "/gnu/store/5h2w4qi9hk1qzzgi1w83220ydslinr4s-glibc-2.33/lib/libdl.so.2", O_RDONLY|O_CLOEXEC) = 3
openat(AT_FDCWD, "/gnu/store/094bbaq6glba86h1d4cj16xhdi6fk2jl-gcc-10.3.0-lib/lib/libgcc_s.so.1", O_RDONLY|O_CLOEXEC) = 3
openat(AT_FDCWD, "/gnu/store/5h2w4qi9hk1qzzgi1w83220ydslinr4s-glibc-2.33/lib/libc.so.6", O_RDONLY|O_CLOEXEC) = 3
openat(AT_FDCWD, "/gnu/store/5h2w4qi9hk1qzzgi1w83220ydslinr4s-glibc-2.33/lib/libpthread.so.0", O_RDONLY|O_CLOEXEC) = 3
openat(AT_FDCWD, "/etc/OpenCL/vendors", O_RDONLY|O_NONBLOCK|O_CLOEXEC|O_DIRECTORY) = -1 ENOENT (No such file or directory)
Number of platforms                               0
+++ exited with 0 +++
</pre>


<p>
It is, however, present:
</p>

<div class="org-src-container">
<pre class="src src-shell">find -L /run/current-system/profile -name libMesaOpenCL.so.1
</pre>
</div>

<pre class="example">
/run/current-system/profile/lib/libMesaOpenCL.so.1
</pre>


<p>
This is mystery number two: why can't Guix locate the library?
</p>

<p>
If we create our own vendors file, populate it with the location of the <code>libMesaOpenCL.so</code> file, and point <code>clinfo</code> at this, things begin to look better.
</p>

<div class="org-src-container">
<pre class="src src-shell">cat ${HOME}/.local/etc/OpenCL/vendors/mesa.icd
</pre>
</div>

<pre class="example">
/run/current-system/profile/lib/libMesaOpenCL.so.1
</pre>


<div class="org-src-container">
<pre class="src src-shell">OPENCL_VENDOR_PATH=${HOME}/.local/etc/OpenCL/vendors clinfo
</pre>
</div>

<pre class="example">
Number of platforms                               0
</pre>


<p>
However, Leela Zero is still not working:
</p>

<div class="org-src-container">
<pre class="src src-shell">OPENCL_VENDOR_PATH=${HOME}/.local/etc/OpenCL/vendors leelaz --tune-only 2&gt;&amp;1 || true
</pre>
</div>

<pre class="example">
A network weights file is required to use the program.
By default, Leela Zero looks for it in /home/katco/.local/share/leela-zero/best-network.
</pre>


<p>
There is a curious error from the output of <code>clinfo</code>:
</p>

<p>
<code>Preferred work group size multiple              &lt;getWGsizes:1200: create kernel : error -46&gt;</code>
</p>

<p>
If we set the <code>LD_DEBUG</code> environment variable to <code>libs</code>, we can shed some light as to what is wrong:
</p>

<div class="org-src-container">
<pre class="src src-shell">OPENCL_VENDOR_PATH=${HOME}/.local/etc/OpenCL/vendors LD_DEBUG=libs clinfo 2&gt;&amp;1 |grep error
</pre>
</div>

<p>
Indeed, this file is not present.
</p>

<div class="org-src-container">
<pre class="src src-shell">[ -f /gnu/store/h86b3253bc3mnp3p57n1vls2vkfv2h6z-libclc-9.0.1/share/clc/gfx1010-amdgcn-mesa-mesa3d.bc ]
echo $?
</pre>
</div>

<pre class="example">
1
</pre>


<p>
Further research turned up a bug (<a href="https://bugs.llvm.org/show_bug.cgi?id=44841">44841</a>) against <code>libclc</code> which suggests that while support for my card was included into LLVM v10 (at the time of this writing, LLVM has released v12), <code>libclc</code> does not support my card's architecture, <code>gfx1010</code>.
</p>

<p>
I attempted to build libclc v12.0.0 locally, but it segfaulted. Building v11.0.0 worked, but as suggested by the open bug, support for my card's architecture still has not been implemented.
</p>

<p>
I briefly entertained creating a Guix package from AMD's <code>amdgpu-pro</code> <a href="https://www.amd.com/en/support/kb/release-notes/rn-radpro-lin-16-40">packages</a>, but it appears as though my card is not supported, and according to a bug (<a href="https://github.com/RadeonOpenCompute/ROCm/issues/819">819</a>) against ROCm, likely won't be.
</p>

<p>
So it would seem I'm out of luck, and I'm stuck running Leela Zero on the CPU for now. Analyzing one of my games on 60 compute cores took somewhere around ten minutes, so not intractable.
</p>

<p>
Still, perhaps this helps others running Guix with GPUs that are supported by <code>libclc</code>.
</p>

<p>
As an aside, this research is perhaps an indication of why — despite my years of interest in Go — I remain a Kyu player.
</p>

    </div>
  </div>
</div> <!-- /.container -->
]]></description>
      <pubDate>2021-07-05</pubDate>
      <guid>http://katherine.cox-buday.com/blog/2021/07/05/trying-opencl-on-guix-an-experience-report/</guid>
    </item>
    <item>
      <title>The Utility of a Cup</title>
      <link>http://katherine.cox-buday.com/blog/2018/07/18/the-utility-of-a-cup/</link>
      <description><![CDATA[<div class="post">
  <div class="col-sm-3 right-align post-meta">
    <h3>&nbsp;<!-- Placeholder for alignment with post --></h3>
  </div>
  <div class="col-sm-9">
    <div class="post">
      <h3>The Utility of a Cup</h3>
      <p>
For awhile now, I've wanted to write about my experiences writing <a href="https://katherine.cox-buday.com/concurrency-in-go">Concurrency in Go</a>. I want to write about what it was like to write a technical book, how I did it, and how I felt about it afterwards. This piece of writing will be about that last bit: how I feel having successfully written the book.
</p>

<p>
When my part was finished, and I was informed that the book was going to print, the first thing I remember feeling is enormous relief. To understand why, I need to reveal a bit about what kind of frame of mind I was in.
</p>

<p>
In 2015, I pitched the idea to O'Reilly, and eventually came to an agreement to write the book. At the time, my daughter was barely walking, and we were living in a house in which I had an office. I was managing a team at <a href="https://canonical.com">Canonical</a> where we were writing a lot of Go, and generally enjoying life.
</p>

<p>
After I had decided to write the book, a number of things happened from early 2016 into mid 2017 that made writing the book significantly more challenging:
</p>

<ul class="org-ul">
<li>My daughter got older and began needing much more supervision than I realized she'd need.</li>
<li>For three unrelated and equally serious reasons, the location our house was in became unsafe to live in, and we had to sell it.</li>
<li>We moved into a small apartment on the first floor of an old home. I lost an office space, and interruptions outside of working hours increased dramatically. A year into living there, we were also surprised with new neighbors upstairs, three young women. They were very loud, and regularly prevented us from sleeping. At night, we'd hear gunshots &#x2013; something I was unaccustomed to. Our garage was broken into. During the summer of 2016, a crime spree broke out in our neighborhood. People were being carjacked, forced to drive to withdraw money from ATMs, and sometimes assaulted or killed. We stopped going out after dark, and this effectively eliminated my exercise routine.</li>
<li>A presidential election happened. Fear crept into my psyche, and set up shop.</li>
<li>We couldn't find a house we liked and so decided to try and build one. We bought some land.</li>
<li>There were massive reorganizations at Canonical, and my team was dissolved. I became a software engineer once more (this part was cool!), and was placed on a new team.</li>
<li>Eventually Canonical's 2017 round of layoffs happened. My entire team and I were unexpectedly let go.</li>
<li>A job search ensued, and I found <a href="https://simple.com">Simple</a> (this part was also good!).</li>
<li>For various reasons, we abandoned the idea of building a house, and sold the land.</li>
</ul>

<p>
I am always very reticent to claim hardship in life &#x2013; there are people who have much different and much more serious problems than I do &#x2013; but this sequence of events ground me down like a pestle working a bit of spice. There were no nights off, there were no weekends off, and writing in the apartment was rarely an option<sup><a id="fnr.1" class="footref" href="#fn.1" role="doc-backlink">1</a></sup>. I sacrificed a lot of time with my family, and much of the time I was afraid. It is only in retrospect that I realize I was severely burnt out. Fear is the mind killer.
</p>

<p>
Although I didn't realize why, I began withdrawing from different spaces, and limiting my activities. I now know that I was trying to simplify; to give myself time and space to claw some sense of normalcy back. I quit Twitter, I stopped updating my website. Personal projects were put on hold. I withdrew.
</p>

<hr>

<p>
Occasionally I flip through the Tao Te Ching. I first learned of its existence in high school when we were covering eastern philosophy, and I remember immediately agreeing with a core truth in the philosophy of Taoism: that everything comes in pairs<sup><a id="fnr.2" class="footref" href="#fn.2" role="doc-backlink">2</a></sup>. Light and dark, dry and wet, and so on. Laozi, author of the Tao Te Ching, has a way of distilling problems down into their most base components, and offering equally simple advice.
</p>

<p>
And so, one night, a couple of months after the book had been published, I was searching through the Tao Te Ching for a bit of wisdom on the matter. I wanted insight into how I was feeling, and maybe some advice on how to fix it. That's when I came across this passage:
</p>

<blockquote>
<p>
We join spokes together in a wheel,
but it is the center hole
that makes the wagon move.
We shape clay into a pot,
but it is the emptiness inside
that holds whatever we want.
We hammer wood for a house,
but it is the inner space
that makes it livable.
We work with being,
but non-being is what we use.
</p>
</blockquote>

<p>
This reminded me of <a href="http://www.ashidakim.com/zenkoans/1acupoftea.html">a Zen Koan</a> I had once read:
</p>

<blockquote>
<p>
Nan-in, a Japanese master during the Meiji era (1868-1912), received a university professor who came to inquire about Zen.
</p>

<p>
Nan-in served tea. He poured his visitor's cup full, and then kept on pouring.
</p>

<p>
The professor watched the overflow until he no longer could restrain himself. "It is overfull. No more will go in!"
</p>

<p>
"Like this cup," Nan-in said, "you are full of your own opinions and speculations. How can I show you Zen unless you first empty your cup?"
</p>
</blockquote>

<p>
And finally, a wonderful quote from Bruce Lee:
</p>
<blockquote>
<p>
The usefulness of a cup is in its emptiness.
</p>
</blockquote>

<p>
If I were to draw inspiration from Laozi, and distill how I felt after completing the book into the simplest expression, it would be this: my cup was full. It was so full, I had no room for curiosity, for wonder, or for learning. This is why I had withdrawn: to empty my cup.
</p>

<p>
At the time of this writing it's been almost a year since "Concurrency in Go" has been published. I'm very happy to say that I have begun to feel like I have a little more room in my cup. We're now living in a safe and quiet house. I've completed quite a few projects to establish a fun home computing lab, with more private and public projects in the pipeline (this post was one of them!). I have an office again. And this space is giving me the strength to face some of the fear I've had since the election, and to develop ideas for helping others. I'm doing good.
</p>

<p>
And with this space, I am finally able to reflect on how I feel having written the book. At the end of the day, am I happy I decided to write this book? Yes; I am very happy to have written Concurrency in Go. In its preface I say:
</p>

<blockquote>
<p>
I wanted the community to have access to high-quality and comprehensive information about concurrency in Go&#x2026;
</p>
</blockquote>

<p>
That altruistic justification still rings true, and since the book was published, I've had several people tell me how much it has helped them. It may have been a difficult journey, but the destination has been worth it.
</p>
<div id="footnotes">
<h2 class="footnotes">Footnotes: </h2>
<div id="text-footnotes">

<div class="footdef"><sup><a id="fn.1" class="footnum" href="#fnr.1" role="doc-backlink">1</a></sup> <div class="footpara" role="doc-footnote"><p class="footpara">
It's for this reason that in my acknowledgments I thank the wonderful St. Louis library system! Support your libraries!
</p></div></div>

<div class="footdef"><sup><a id="fn.2" class="footnum" href="#fnr.2" role="doc-backlink">2</a></sup> <div class="footpara" role="doc-footnote"><p class="footpara">
I have often wondered how qubits might be regarded under Taoism.
</p></div></div>


</div>
</div>
    </div>
  </div>
</div> <!-- /.container -->
]]></description>
      <pubDate>2018-07-18</pubDate>
      <guid>http://katherine.cox-buday.com/blog/2018/07/18/the-utility-of-a-cup/</guid>
    </item>
    <item>
      <title></title>
      <link>http://katherine.cox-buday.com/concurrency-in-go/</link>
      <description><![CDATA[<div class="post">
  <div class="col-sm-3 right-align post-meta">
    <h3>&nbsp;<!-- Placeholder for alignment with post --></h3>
  </div>
  <div class="col-sm-9">
    <div class="post">
      <h3></h3>
      
<div id="org5a93334" class="figure">
<p><img src="/assets/concurrency-in-go/book-cover.jpg" alt="book-cover.jpg" class="img-responsive pull-left" style="margin-right:15px; width:250px" />
</p>
</div>

<p>
Concurrency can be notoriously difficult to get right, but fortunately, the Go programming language was designed with concurrency in mind. In this practical book, you’ll learn how Go was written to help introduce and master these concepts, as well as how to use basic concurrency patterns to form large systems that are reliable and remain simple and easy to understand.
</p>

<p>
Author Katherine Cox-Buday takes you through the tools and techniques to develop and debug concurrent software. After finishing Concurrency in Go, you’ll be equipped with the skills you need to confidently and correctly write concurrent systems of any size.
</p>

<p>
[<a href="https://github.com/kat-co/concurrency-in-go-src">Source Code</a>] [<a href="http://www.oreilly.com/catalog/errata.csp?isbn=0636920046189">Errata</a>]
</p>
<div class="clearfix"></div>

<div id="outline-container-orgd9c94df" class="outline-2">
<h2 id="orgd9c94df">Available for Purchase</h2>
<div class="outline-text-2" id="text-orgd9c94df">
<ul class="org-ul">
<li><a href="http://www.ebooks.com/95820962/concurrency-in-go/cox-buday-katherine/">ebooks.com</a> (DRM free!)</li>
<li><a href="https://www.amazon.com/gp/product/1491941197/ref=as_li_qf_sp_asin_il_tl?ie=UTF8&amp;tag=katherinecoxb-20&amp;camp=1789&amp;creative=9325&amp;linkCode=as2&amp;creativeASIN=1491941197&amp;linkId=50618894344eaf64dbf967755272d941">Amazon</a></li>
<li><a href="http://www.barnesandnoble.com/w/concurrency-in-go-katherine-cox-buday/1123863796">Barnes &amp; Noble</a></li>
<li>A local independent bookstore near you!</li>
</ul>
</div>
</div>

    </div>
  </div>
</div> <!-- /.container -->
]]></description>
      <pubDate>2017-12-03</pubDate>
      <guid>http://katherine.cox-buday.com/concurrency-in-go/</guid>
    </item>
    <item>
      <title>On Perfectionism</title>
      <link>http://katherine.cox-buday.com/blog/2015/03/02/on-perfectionism/</link>
      <description><![CDATA[<div class="post">
  <div class="col-sm-3 right-align post-meta">
    <h3>&nbsp;<!-- Placeholder for alignment with post --></h3>
  </div>
  <div class="col-sm-9">
    <div class="post">
      <h3>On Perfectionism</h3>
      <p>
I recently came across this Tweet:
</p>

<blockquote class="twitter-tweet" lang="en"><p><a href="http://t.co/meyTVhEscW">http://t.co/meyTVhEscW</a> <a href="http://t.co/VyIujIx2dZ">pic.twitter.com/VyIujIx2dZ</a></p>&mdash; Paul Baumgart (@paulbaumgart) <a href="https://twitter.com/paulbaumgart/status/571788242174918656">February 28, 2015</a></blockquote>
<script async src="//platform.twitter.com/widgets.js" charset="utf-8"></script>

<p>
I've spent most of my career in the financial industry. There, it was unacceptable to release code which didn't work, and acceptable for the time between releases to span months; because if you got something wrong, it could have led to significant financial losses. It was a different type of job, and discussion of the pros/cons of this type of environment is probably outside the scope of this post.
</p>

<p>
I've changed jobs now, but I'm still trying to shake one of the detrimental habits the financial industry trained me into: perfectionism.
</p>

<p>
Now admittedly, I can't rest <i>all</i> of the blame on my previous job. Perfectionism is something that's innate to my character as well. Perhaps working in that type of environment just helped further crystallize a way of working.
</p>

<p>
And it's not all bad. It's partially what drives me: the desire to release pristine code leads to (what I consider) some nice patches and projects. It is sometimes the driving force behind <i>starting</i> some changes. It can be a really positive thing.
</p>

<p>
But it can also be negative.
</p>

<p>
The Open Source mantra is, "Release early; release often." I think the justification lies within the parable from this tweet. Humans are really good at modeling the future &#x2013; it's what makes us the dominant species on Earth. But when working with things as complex as software, this modeling has limits. The better way to work is to make mistakes as fast as possible, and iterate towards perfection.
</p>

<p>
I have found myself trying to get everything perfect before pushing changes up to their respective repositories. And sometimes I even find this blocking me from getting started. <i>All</i> the different approaches, their pros and cons, possible edge cases: they're all floating around in my mind, and it's difficult to just get started and get something working. Usually once I do get a bit of code written, I'm off and away and things are fine, but sometimes it's hard to get past that first block.
</p>

<p>
Those familiar with perfectionism are probably nodding their heads. It's a well understood problem, and there are some things you can do to try and get past it.
</p>

<p>
In the context of software engineering, one thing I've found that helps is to write tests. Tests are usually much more plain, and are &#x2013; by design &#x2013; meant to test one thing at a time. If edge-cases appear, you should probably write a test for that anyway, and so you can get a fair amount of work by simply building out the scaffolding of the program by writing tests. This gets you to lay down some code, and possibly removes the mental block.
</p>

<p>
I haven't found any other useful ways to resist the siren call of perfectionism (indeed I'm having trouble getting this post out!), but I at least thought this tweet would be a friendly reminder as to why it's better to fail as fast as you can.
</p>

    </div>
  </div>
</div> <!-- /.container -->
]]></description>
      <pubDate>2017-01-23</pubDate>
      <guid>http://katherine.cox-buday.com/blog/2015/03/02/on-perfectionism/</guid>
    </item>
    <item>
      <title>Gorkin: An Experiment with Cucumber &amp; BDD</title>
      <link>http://katherine.cox-buday.com/blog/2015/07/09/gorkin-an-experiment-with-cucumber-&amp;-bdd/</link>
      <description><![CDATA[<div class="post">
  <div class="col-sm-3 right-align post-meta">
    <h3>&nbsp;<!-- Placeholder for alignment with post --></h3>
  </div>
  <div class="col-sm-9">
    <div class="post">
      <h3>Gorkin: An Experiment with Cucumber &amp; BDD</h3>
      <iframe width="560" height="315" src="https://www.youtube.com/embed/RuFrIq0f5Es" frameborder="0" allowfullscreen></iframe>

<p>
(<a href="https://github.com/kat-co/gorkin">repository</a>)
</p>

    </div>
  </div>
</div> <!-- /.container -->
]]></description>
      <pubDate>2017-01-20</pubDate>
      <guid>http://katherine.cox-buday.com/blog/2015/07/09/gorkin-an-experiment-with-cucumber-&amp;-bdd/</guid>
    </item>
    <item>
      <title>An Argument for Parameter Validation</title>
      <link>http://katherine.cox-buday.com/blog/2014/07/31/an-argument-for-parameter-validation/</link>
      <description><![CDATA[<div class="post">
  <div class="col-sm-3 right-align post-meta">
    <h3>&nbsp;<!-- Placeholder for alignment with post --></h3>
  </div>
  <div class="col-sm-9">
    <div class="post">
      <h3>An Argument for Parameter Validation</h3>
      <p>
I'm a fan of validating parameters in languages which do not have preconditions.
</p>

<p>
First, let's define what I mean when I say validation.
</p>
<pre class="example">
Parameter validation is ensuring the things you utilize are in a state in which you can use them.
</pre>

<p>
Many people hear parameter validation and immediately jump to this:
</p>

<div class="org-src-container">
<pre class="src src-java">public void AnImportantMethod(report Report, author Author, repository Repository) {
    if(report == null)
      throw new NullPointerException("report");
    if(author == null)
      throw new NullPointerException("author");
    if(repository == null)
      throw new NullPointerException("repository");


    // Finally, our code!
    // ...
}
</pre>
</div>

<p>
Although checking for null values is a large responsibility of validating parameters, parameter validation isn't constrained to this. If you accept an integer, but want to make sure it falls within a range, that's parameter validation. If you want to ensure the object you're passed is in a known/correct state, that's parameter validation. If you want to make sure your business-object adheres to business rules that pertain to what you're going to do, that's parameter validation.
</p>

<p>
A code-base of any decent side will have disparate subsystems in various states of coupling. The way these systems interact can be subtle, and the data they share can have an infinite domain (strings, numbers), or at least be very complex (classes which break the law of demeter &#x2013; admit it, you have a few). Rather than try and reason about your entire code-base as a whole, I find it much easier to worry about the one thing my component is doing, and make sure it has everything it needs before getting started. So how do you go about this?
</p>

<p>
When reasoning about the correctness of your data, you have a few options:
</p>

<ol class="org-ol">
<li>Relying on the fact that the data was generated and transformed correctly everywhere else.</li>
<li>Defining coarse boundaries and validating data there (think user-input coming in).</li>
<li>Validating the data right before you use it.</li>
</ol>

<p>
Which should you choose?
</p>

<p>
Let's get a little philosophical. The ways in which the code boundary you are guarding are interacted with are discrete and finite at this moment in time. Let's call that number A. If you're lucky, perhaps A is some small number &#x2013; perhaps even 1 &#x2013; and you can reason about what data makes it across your code boundary.
</p>

<p>
But over time, A will change in ways you cannot predict (if you can, talk to me, and we'll make lots of money together). Architecture will change, the scope of your boundary might expand, the permutations that create your arguments might blow your data's domain out to some large number, code that didn't even exist might begin lobbing bytes across: you just don't know.
</p>

<p>
So perhaps it's because I'm paranoid, but I like to validate my inputs as close to their use as possible. The boundary I usually choose is methods. At the beginning of every method I do any validation I need to do to ensure that I at least started in a known state.
</p>

<p>
There are advantages and disadvantages to this technique.
</p>

<div id="outline-container-org118e2e8" class="outline-2">
<h2 id="org118e2e8">Advantages</h2>
<div class="outline-text-2" id="text-org118e2e8">
<ol class="org-ol">
<li><p>
<b>Adherence to the <a href="http://en.wikipedia.org/wiki/Fail-fast">Fail Fast principle</a>.</b>
</p>

<p>
Don't know why that's a good thing? Check out <a href="http://www.martinfowler.com/ieeeSoftware/failFast.pdf">this</a> great article.
</p></li>

<li><p>
<b>Complete Coverage</b>
</p>

<p>
No matter how your code is called, it will be validated.
</p></li>

<li><p>
<b>Code Contracts</b>
</p>

<p>
If I'm calling this code, what can I pass in? Are nulls OK? If I'm reading the code, this gives me an indication. If I'm calling the code, I know right away.
</p></li>
</ol>
</div>
</div>

<div id="outline-container-orgc6c5b28" class="outline-2">
<h2 id="orgc6c5b28">Disadvantages</h2>
<div class="outline-text-2" id="text-orgc6c5b28">
<ol class="org-ol">
<li><p>
<b>Performance</b>
</p>

<p>
If you call a guarded block of code repeatedly, validation can slow your program down demonstrably; however, this is an edge case and you shouldn't discard the entire concept of parameter validation at the altar of premature optimization.
</p></li>

<li><p>
<b>Verbosity</b>
</p>

<p>
It's extra lines of code &#x2013; no way around it &#x2013; however, given the potential benefit, this disadvantage seems insignificant. Further, there's ways to even further minimize this downside discussed below.
</p></li>

<li><p>
<b>Duplication of Effort</b>
</p>

<p>
This is the one I struggle with most. How many times are you going to check that an instance of a string is not empty before you believe it? There's some truth to this, but only in the simple case. As mentioned above, what string you are passed could change in the future; so in a sense we are guarding against the domain of values, not specific instances.
</p></li>
</ol>
</div>
</div>

<div id="outline-container-orge7e6567" class="outline-2">
<h2 id="orge7e6567">Smart Parameter Validation</h2>
<div class="outline-text-2" id="text-orge7e6567">
<p>
A long chain of if statements at the beginning of your code is cumbersome to write and maintain. It's prone to bugs, and it can actually hide incorrect parameters which are checked after other failing parameters. Do your parameter validation smarter:
</p>

<div class="org-src-container">
<pre class="src src-go">func PersistCreeps(dataStore io.Writer, creeps []*game.Creep) error {

    BeginValidation().Validate(
        IsNotNil(dataStore, "dataStore"),
        IsNotNil(creeps, "creeps"),
    ).CheckAndPanic().Validate(
        GreaterThan(len(creeps), 0, "creeps"),
    ).CheckAndPanic()

        // ...
}
</pre>
</div>

<p>
What the heck is that? It's a fluent style of parameter validation I picked up from the author of Paint.Net, Rick Brewster, in an <a href="http://blog.getpaint.net/2008/12/06/a-fluent-approach-to-c-parameter-validation/">article</a> he wrote. It chains together validation, and returns a single error containing all failures. You can also extend it to contain arbitrarily complex validators:
</p>

<div class="org-src-container">
<pre class="src src-go">func ReportFitsRepository(report *Report, repository *Repository) Checker {
    return func() (passes bool, err error) {

        err = fmt.Errorf("A %s report does not belong in a %s repository.", report.Type, repository.Type)
        passes = (repository.Type == report.Type)
        return passes, err
    }
}

func AuthorCanUpload(authorName string, repository *Repository) Checker {
    return func() (passes bool, err error) {
        err = fmt.Errorf("%s does not have access to this repository.", authorName)
        passes = !repository.AuthorCanUpload(authorName)
        return passes, err
    }
}

func AuthorIsCollaborator(authorName string, report *Report) Checker {
    return func() (passes bool, err error) {

        err = fmt.Errorf("The given author was not one of the collaborators for this report.")
        for _, collaboratorName := range report.Collaborators() {
            if collaboratorName == authorName {
                passes = true
                break
            }
        }
        return passes, err
    }
}

func HandleReport(authorName string, report *Report, repository *Repository) {

    BeginValidation().Validate(
        AuthorIsCollaborator(authorName, report),
        AuthorCanUpload(authorName, repository),
        ReportFitsRepository(report, repository),
    ).CheckAndPanic()
}
</pre>
</div>

<p>
Here we can see that parameter validation doesn't have to be verbose, or even hard to write. In fact, if done properly, parameter validation can bring a lot of clarity to your code, and give developers a sense of what you expect data to look like when passing your code boundary.
</p>

<p>
If you're interested in this style of parameter validation, and are working with Go, check out my validation library, <a href="https://github.com/kat-co/vala">Vala</a>.
</p>
</div>
</div>

    </div>
  </div>
</div> <!-- /.container -->
]]></description>
      <pubDate>2017-01-19</pubDate>
      <guid>http://katherine.cox-buday.com/blog/2014/07/31/an-argument-for-parameter-validation/</guid>
    </item>
    <item>
      <title>Why this Year I&#39;m Focusing on Charity.</title>
      <link>http://katherine.cox-buday.com/blog/2014/12/03/why-this-year-im-focusing-on-charity/</link>
      <description><![CDATA[<div class="post">
  <div class="col-sm-3 right-align post-meta">
    <h3>&nbsp;<!-- Placeholder for alignment with post --></h3>
  </div>
  <div class="col-sm-9">
    <div class="post">
      <h3>Why this Year I&#39;m Focusing on Charity.</h3>
      <p>
I am fortunate in my life that I have nurtured a career that not only helps to sustain my family but allows me enough money to enjoy some recreational things. It is for this reason that I'm not sure whether my growing distaste for consumerism has just come with age, or if it's because I can afford things I would like. Either way, I have come to loathe this time of year in The United States.
</p>

<p>
I feel inundated by commercials telling me to buy now, that I should get what I really want this year. Here's a BMW that I deserve. Here's a diamond necklace he had better get me. Here's me suppressing a gag reflex.
</p>

<p>
I'm not out and out against people wanting things -- or gifts. That's all fine (I even have a few items on my list). It's the exuberance of what the last fourth of the year has come to represent. We have an entire season of procurement and societal greed. I've reached a tipping point in my life where the very idea of me sitting down and putting thought into a list of more things I want to acquire leaves a bad taste in my mouth. I don't need more stuff -- no matter how hard the advertising industry tries to sell it. What I would like to do this year is cultivate compassion, and establish a pattern my newborn daughter can look up to. When I think of this time of year, I don't want to think of the exuberance of excess, I want to think of others, and how I can possibly contribute in some small way to the betterment of the world.
</p>

<p>
So last night I sat down and I did make a list. I made a list of charities I'd like to support this year, and going forward. If you're in a position where you don't really need anything, I encourage you to at least stop and think about what this time of year means to you, and whether more things will really enhance your life.
</p>

<p>
Happy holidays, everyone.
</p>

<p>
Katherine
</p>

<ul class="org-ul">
<li>NAMI (<a href="http://www.charitynavigator.org/index.cfm?bay%3Dsearch.summary&amp;orgid%3D4827">National Alliance on Mental Illness</a>)</li>
<li>HRC (<a href="http://www.charitynavigator.org/index.cfm?bay%3Dsearch.summary&amp;orgid%3D6229">The Human Rights Campaign</a>)</li>
<li>WWF (<a href="http://www.charitynavigator.org/index.cfm?bay%3Dsearch.summary&amp;orgid%3D4770">World Wildlife Fund</a>)</li>
<li>Wikimedia Foundation (<a href="http://www.charitynavigator.org/index.cfm?bay%3Dsearch.summary&amp;orgid%3D11212">Wikipedia</a>)</li>
</ul>

    </div>
  </div>
</div> <!-- /.container -->
]]></description>
      <pubDate>2017-01-19</pubDate>
      <guid>http://katherine.cox-buday.com/blog/2014/12/03/why-this-year-im-focusing-on-charity/</guid>
    </item>
    <item>
      <title>Simplicity and Go</title>
      <link>http://katherine.cox-buday.com/blog/2015/07/08/simplicity-and-go/</link>
      <description><![CDATA[<div class="post">
  <div class="col-sm-3 right-align post-meta">
    <h3>&nbsp;<!-- Placeholder for alignment with post --></h3>
  </div>
  <div class="col-sm-9">
    <div class="post">
      <h3>Simplicity and Go</h3>
      <iframe width="560" height="315" src="https://www.youtube.com/embed/S6mEo_FHZ5Y" frameborder="0" allowfullscreen></iframe>

<p>
(<a href="/assets/blog/2015/07/08/simplicity-and-go/simplicity-and-go.pdf">slides</a>)
</p>

    </div>
  </div>
</div> <!-- /.container -->
]]></description>
      <pubDate>2017-01-19</pubDate>
      <guid>http://katherine.cox-buday.com/blog/2015/07/08/simplicity-and-go/</guid>
    </item>
    <item>
      <title>Analyzing Opentracing for Go</title>
      <link>http://katherine.cox-buday.com/blog/2016/06/06/analyzing-opentracing-for-go/</link>
      <description><![CDATA[<div class="post">
  <div class="col-sm-3 right-align post-meta">
    <h3>&nbsp;<!-- Placeholder for alignment with post --></h3>
  </div>
  <div class="col-sm-9">
    <div class="post">
      <h3>Analyzing Opentracing for Go</h3>
      <p>
I'm in the middle of designing the architecture for an audit log for <a href="https://jujucharms.com">Juju</a>, and some of my colleagues suggested <a href="http://opentracing.io/">OpenTracing</a>. I flipped through the site and it looks like it might meet our needs quite nicely, and so I've set out to do a deeper analysis to make sure it's something that is a good fit. I'm hoping this post will serve as a place I can point my coworkers for that analysis, as well as to help anyone else considering utilizing this project.
</p>

<p>
Juju is written in Go, and so I'll be taking a look at the <a href="https://github.com/opentracing/opentracing-go">Go implementation</a> of the project. I'm going to ignore any kind of general overview as the project's web page does a pretty good job of that. Instead this post will focus on the things that aren't immediately apparent: ease of use, and performance.
</p>

<p>
With that said, on to the analysis!
</p>

<div id="outline-container-org21f45ee" class="outline-2">
<h2 id="org21f45ee">Key Concepts</h2>
<div class="outline-text-2" id="text-org21f45ee">
<ul class="org-ul">
<li><b>span</b>: A logical unit of work in the system.</li>
<li><b>baggage</b>: Information intended to be carried on to subsequent spans.</li>
<li><b>tracer</b>: Manages spans. A <b>trace</b> is a tree of spans.</li>
<li><b>recorder</b>: Records span information to the system's backing-store.</li>
</ul>
</div>
</div>

<div id="outline-container-org5300ac5" class="outline-2">
<h2 id="org5300ac5">Sanity Check</h2>
<div class="outline-text-2" id="text-org5300ac5">
<p>
First of all, the <a href="https://github.com/opentracing/opentracing-go/blob/master/LICENSE">license</a> is MIT. No issues there.
</p>

<p>
At the time of this post, the project has 110 stars on GitHub, the last merge was 14 days ago, and there are 5 open issues, 15 closed. As far as project activity goes, looks OK.
</p>

<p>
Juju also has Python bindings to its API, so ideally any tracing standard will be polyglot implementation. It looks like Opentrace does have Python binding, and it also looks like Java, JavaScript, Objective C, C++, PHP, and Ruby are in <a href="http://opentracing.io/integration/">various stages</a> of support. We should be good to go.
</p>
</div>
</div>

<div id="outline-container-org36818a6" class="outline-2">
<h2 id="org36818a6">Performance</h2>
<div class="outline-text-2" id="text-org36818a6">
<p>
First the obvious question. If I'm going to be embedding a lot of spans, this needs to be fast. How quick is it to create and tear down a new span?
</p>

<div class="org-src-container">
<pre class="src src-go">func BenchmarkSpanCreation(b *testing.B) {
    for i := b.N; i &gt;= 0; i-- {
        s := opentracing.StartSpan(fmt.Sprintf("span %d", i))
        s.Finish()
    }
}
</pre>
</div>

<div class="org-src-container">
<pre class="src src-sh">go test /tmp/analyzing-opentrace/b_span_creation_test.go
</pre>
</div>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<tbody>
<tr>
<td class="org-left">ok</td>
<td class="org-left">command-line-arguments</td>
<td class="org-left">0.003s</td>
</tr>
</tbody>
</table>

<p>
Looks to be fast enough to be non-impactful. What about creating spans from other spans?
</p>

<div class="org-src-container">
<pre class="src src-go">func BenchmarkChildSpanCreation(b *testing.B) {
    p := opentracing.StartSpan("parent-spam")
    defer p.Finish()
    for i := b.N; i &gt;= 0; i-- {
        s := opentracing.StartChildSpan(p, fmt.Sprintf("child-span-%d", i))
        s.Finish()
    }
}
</pre>
</div>

<div class="org-src-container">
<pre class="src src-sh">go test /tmp/analyzing-opentrace/b_span_child_creation_test.go
</pre>
</div>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<tbody>
<tr>
<td class="org-left">ok</td>
<td class="org-left">command-line-arguments</td>
<td class="org-left">0.026s</td>
</tr>
</tbody>
</table>

<p>
Also reasonable. Our RPC system utilizes web sockets; if we were to inject span information, how much extra space could we expect it to take up?
</p>

<div class="org-src-container">
<pre class="src src-go">tracer := basictracer.New(nil)

httpReq, _ := http.NewRequest("GET", "http://myservice/", nil)
fmt.Printf("Header (before): %v\n", httpReq.Header)

s := tracer.StartSpan("my-span")
// defer s.Finish() &lt;-- Normally we would call this to trigger writes by the recorder
s.LogEvent("test event")
s.SetBaggageItem("my-baggage", "current user")

tracer.Inject(s, opentracing.TextMap, opentracing.HTTPHeaderTextMapCarrier(httpReq.Header))
fmt.Printf("Header (after): %v\n", httpReq.Header)
</pre>
</div>

<pre class="example">
Header (before): map[]
Header (after): map[Ot-Tracer-Traceid:[7ab6ba52e1e748c1] Ot-Tracer-Spanid:[1b4c98c3b3f048aa] Ot-Tracer-Sampled:[false] Ot-Baggage-My-Baggage:[current+user]]
</pre>


<p>
Looks pretty reasonable; just some information about the spans for the receiver to pick up the trace.
</p>
</div>
</div>

<div id="outline-container-org1cfdf9c" class="outline-2">
<h2 id="org1cfdf9c">Integration with Juju</h2>
<div class="outline-text-2" id="text-org1cfdf9c">
</div>
<div id="outline-container-org8cae748" class="outline-3">
<h3 id="org8cae748">Gating API Calls</h3>
<div class="outline-text-3" id="text-org8cae748">
<p>
Juju's API server is the bottleneck gating access to and from a Juju daemon and is the natural place to ensure a trace either exists or is started. Ideally the things calling Juju's API server would have started a trace, but if not, we need to ensure that one exists. Let's first see how we can ensure that all API server connections know about OpenTracing and spans.
</p>

<p>
Ideally I wish I could decorate our API server endpoints so that the cross-cutting concern of injecting tracing could be encapsulated elsewhere, but Go doesn't make this easy. The next best thing is to inject the tracing information into all API requests.
</p>

<p>
Go's <code>context.Context</code> type has become the standard way at providing context to long-running processes, and so it makes sense to create a type that conforms to that interface and also has OpenTracing information embedded so that functions and methods down the call-tree can either perform traces or do the things <code>context.Context</code> advertises it can do.
</p>

<p>
It is a little strange to utilize <code>context.Context</code> along-side Juju's RPC implementation because timeouts are already baked in, but as this has become the standard way of managing things like this in Go, I think we should move this way. So how would we go about injecting a <code>context.Context</code> into all API calls?
</p>

<p>
In <a href="https://github.com/juju/juju/blob/master/apiserver/root.go#L119-L127">apiserver/root.go</a> there is a method which utilizes reflection to perform a call on API server methods. It looks like this:
</p>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 1: </span>github.com/juju/juju/apiserver/root.go</label><pre class="src src-go">// Call takes the object Id and an instance of ParamsType to create an
// object and place a call on its method. It then returns an instance
// of ResultType.
func (s *srvCaller) Call(objId string, arg reflect.Value) (reflect.Value, error) {
    objVal, err := s.creator(objId)
    if err != nil {
        return reflect.Value{}, err
    }
    return s.objMethod.Call(objVal, arg) // &lt;1&gt;
}
</pre>
</div>

<p>
The interesting bit is at &lt;1&gt; where we call an API's server endpoint and pass in the method receiver and a struct which is depersisted from the client. The <code>Call</code> method is something specific to Juju's RPC mechanism and has the following function signature:
</p>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 2: </span>github.com/rpc/rpcreflect/type.go</label><pre class="src src-go">// Call calls the method with the given argument on the given receiver
// value. If the method does not return a value, the returned value
// will not be valid.
Call func(rcvr, arg reflect.Value) (reflect.Value, error)
</pre>
</div>

<p>
It's instantiated at the time the RPC call is made and by reflecting on the type of facade registered on the server. Here's the interesting bit:
</p>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 3: </span>github.com/juju/rpc/rpcreflect/type.go</label><pre class="src src-go">func newMethod(m reflect.Method, receiverKind reflect.Kind) *ObjMethod {
    if m.PkgPath != "" {
        return nil
    }
    var p ObjMethod
    var assemble func(arg reflect.Value) []reflect.Value
    // N.B. The method type has the receiver as its first argument
    // unless the receiver is an interface.
    receiverArgCount := 1
    if receiverKind == reflect.Interface {
        receiverArgCount = 0
    }
    t := m.Type
    switch {                    // &lt;1&gt;
    case t.NumIn() == 0+receiverArgCount:
        // Method() ...
        assemble = func(arg reflect.Value) []reflect.Value {
            return nil
        }
    case t.NumIn() == 1+receiverArgCount:
        // Method(T) ...
        p.Params = t.In(receiverArgCount)
        assemble = func(arg reflect.Value) []reflect.Value {
            return []reflect.Value{arg}
        }
    default:
        return nil
    }

    switch {
    case t.NumOut() == 0:
        // Method(...)
        p.Call = func(rcvr, arg reflect.Value) (r reflect.Value, err error) {
            rcvr.Method(m.Index).Call(assemble(arg))
            return
        }
    case t.NumOut() == 1 &amp;&amp; t.Out(0) == errorType:
        // Method(...) error
        p.Call = func(rcvr, arg reflect.Value) (r reflect.Value, err error) {
            out := rcvr.Method(m.Index).Call(assemble(arg))
            if !out[0].IsNil() {
                err = out[0].Interface().(error)
            }
            return
        }
    case t.NumOut() == 1:
        // Method(...) R
        p.Result = t.Out(0)
        p.Call = func(rcvr, arg reflect.Value) (reflect.Value, error) {
            out := rcvr.Method(m.Index).Call(assemble(arg))
            return out[0], nil
        }
    case t.NumOut() == 2 &amp;&amp; t.Out(1) == errorType:
        // Method(...) (R, error)
        p.Result = t.Out(0)
        p.Call = func(rcvr, arg reflect.Value) (r reflect.Value, err error) {
            out := rcvr.Method(m.Index).Call(assemble(arg))
            r = out[0]
            if !out[1].IsNil() {
                err = out[1].Interface().(error)
            }
            return
        }
    default:
        return nil
    }
    // The parameters and return value must be of struct type.
    if p.Params != nil &amp;&amp; p.Params.Kind() != reflect.Struct { // &lt;2&gt;
        return nil
    }
    if p.Result != nil &amp;&amp; p.Result.Kind() != reflect.Struct {
        return nil
    }
    return &amp;p
}
</pre>
</div>

<p>
You can see at &lt;1&gt; that we're specifying that the there can be at most 1 argument, and at &lt;2&gt; that this argument must be a struct.
</p>

<p>
If we want to also pass a <code>context.Context</code> into the API server method, we'll have to modify both the signature, <i>and</i> all the existing API methods. Then, in the generic API server connection handling logic back in <a href="https://github.com/juju/juju/blob/master/apiserver/root.go#L119-L127">apiserver/root.go</a>, we would join to the incoming span, or &#x2013; if the caller doesn't know about spans &#x2013; create our own, and then pass the span into the <code>context.Context</code>. It would probably look something like this:
</p>

<div class="org-src-container">
<pre class="src src-go">// Call takes the object Id and an instance of ParamsType to create an
// object and place a call on its method. It then returns an instance
// of ResultType.
func (s *srvCaller) Call(ctx context.Context, objId string, arg reflect.Value) (reflect.Value, error) {
    objVal, err := s.creator(objId)
    if err != nil {
        return reflect.Value{}, err
    }

    return s.objMethod.Call(objVal, ctx, arg)
}
</pre>
</div>

<p>
The <code>ctx</code> would in turn be created further up the stack from our request headers:
</p>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 4: </span>github.com/juju/juju/rpc/server.go</label><pre class="src src-go">func (conn *Conn) handleRequest(hdr *Header) error {
    serverSpan, err := opentracing.GlobalTracer().Join(
        "serverSpan",
        opentracing.TextMap,
        opentracing.HTTPHeaderTextMapCarrier(hdr),
    )
    if err != nil {
        // Create a root span if necessary
        serverSpan = opentracing.StartTrace("serverSpan")
    }

    var ctx context.Context
    ctx, _ = opentracing.ContextWithSpan(ctx, serverSpan)
    defer serverSpan.Finish()

    // TODO(perrito666) 2016-05-02 lp:1558657
    startTime := time.Now()
    req, err := conn.bindRequest(hdr)
    if err != nil {
        conn.notifier.ServerRequest(hdr, nil)
        if err := conn.readBody(nil, true); err != nil {
            return err
        }
        // We don't transform the error here. bindRequest will have
        // already transformed it and returned a zero req.
        return conn.writeErrorResponse(hdr, err, startTime)
    }
    var argp interface{}
    var arg reflect.Value
    if req.ParamsType() != nil {
        v := reflect.New(req.ParamsType())
        arg = v.Elem()
        argp = v.Interface()
    }
    if err := conn.readBody(argp, true); err != nil {
        conn.notifier.ServerRequest(hdr, nil)
        // If we get EOF, we know the connection is a
        // goner, so don't try to respond.
        if err == io.EOF || err == io.ErrUnexpectedEOF {
            return err
        }
        // An error reading the body often indicates bad
        // request parameters rather than an issue with
        // the connection itself, so we reply with an
        // error rather than tearing down the connection
        // unless it's obviously a connection issue.  If
        // the error is actually a framing or syntax
        // problem, then the next ReadHeader should pick
        // up the problem and abort.
        return conn.writeErrorResponse(hdr, req.transformErrors(err), startTime)
    }
    if req.ParamsType() != nil {
        conn.notifier.ServerRequest(hdr, arg.Interface())
    } else {
        conn.notifier.ServerRequest(hdr, struct{}{})
    }
    conn.mutex.Lock()
    closing := conn.closing
    if !closing {
        conn.srvPending.Add(1)
        go conn.runRequest(req, ctx, arg, startTime)
    }
    conn.mutex.Unlock()
    if closing {
        // We're closing down - no new requests may be initiated.
        return conn.writeErrorResponse(hdr, req.transformErrors(ErrShutdown), startTime)
    }
    return nil
}
</pre>
</div>
</div>
</div>

<div id="outline-container-org85dc983" class="outline-3">
<h3 id="org85dc983">Backwards compatibility</h3>
<div class="outline-text-3" id="text-org85dc983">
<p>
Since The API server gate looks for an incoming span but does not expect it, all existing clients &#x2013; including those from prior versions of Juju &#x2013; should be able to utilize the new endpoints. Thus, we should remain backwards compatible, and no new upgrade steps need be written.
</p>
</div>
</div>

<div id="outline-container-orgb2e97c8" class="outline-3">
<h3 id="orgb2e97c8">Writing Audit Events to Mongo</h3>
<div class="outline-text-3" id="text-orgb2e97c8">
<p>
Juju uses <a href="https://www.mongodb.com/">mongoDB</a> for it's data tier. All audit events will be written to a Mongo collection. To do this, we'll write our own OpenTracing recorder which will do nothing but persist audit events to the collection. It will probably look very similar to the provided <a href="https://github.com/opentracing/basictracer-go">basic tracer</a>.
</p>
</div>
</div>
</div>

    </div>
  </div>
</div> <!-- /.container -->
]]></description>
      <pubDate>2016-06-06</pubDate>
      <guid>http://katherine.cox-buday.com/blog/2016/06/06/analyzing-opentracing-for-go/</guid>
    </item>
  </channel>
</rss>